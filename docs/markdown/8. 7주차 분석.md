## **STEP 13 기본**
1. 조회가 오래 걸리는 쿼리에 대한 `캐싱` 을 통해 성능 개선할 수 있는 로직을 분석하고 이를 합리적인 이유와 함께 정리 
2. Redis 를 이용한 `로직 이관`을 통해 성능 개선할 수 있는 로직을 분석하고 이를 합리적인 이유와 함께 정리


## 1. 조회가 오래 걸리는 쿼리
조회가 오래 걸린다면, 1. **데이터가 너무 크거나** 2. **요청이 너무 많은 경우** 입니다.  

현재 과제에서 콘서트 관련 조회의 데이터가 크지 않지만, 요청이 너무 많기 때문에 **Redis** 이용하여 캐싱을 하겠습니다.

**Redis**와 같이 글로벌 캐싱을 택하는 이유는 여러 서버 인스턴스가 각각의 콘서트 상태를 다르게 저장하는 정합성 문제를 최소화하기 위해서입니다.

또한, 콘서트는 많은 조회가 있기에 캐시를 먼저 확인 후 없다면 DB에 조회할 것입니다.  
(**Look Aside**)

그리고 캐쉬에 먼저 예약 정보를 저장하지 않는다면, 무수히 많은 예약 요청이 DB에 도달하므로, 캐쉬에 먼저 예약 정보를 저장하는 전략을 택하겠습니다.  
(**Write Through**, 단 구현 편의를 위해 동기화는 서버가 하는 방식으로 진행)

<details> 
<summary>캐싱 전략</summary>
캐싱 전략은 **1. Look Aside**, **2. Read Through**, **3. Write Behind**, **4. Write Around**가 있습니다.

### 1. Look Aside
- 캐쉬를 먼저 조회합니다. (있다면 반환).
- 캐쉬 미스시에 서버는 DB와 같은 원본 저장소(Data Store)에 조회한 뒤
- **서버**는 해당 값을 캐쉬에 업데이트 합니다.

**장점**
- 많은 읽기에 적합
- Cache 서버 장애가 나도 괜찮음
- 반복적, 동일 쿼리를 수행하는 서비스에 적합

**단점**
- 캐쉬와 원본 저장소간 정합성 불일치 문제
- 캐시에 데이터가 없다면, 추가적인 시간 소모

> 초기 DB 데이터를 캐쉬에 넣어놓으면 성능 향상을 기대할 수 있다.  
> 이를 **Cache Warming**이라 한다.

### 2. Read Through
- 캐쉬를 먼저 조회합니다. (있다면 반환)
- 캐쉬 미스시에 서버는 DB와 같은 원본 저장소(Data Store)에 조회
- **원본 저장소**는 해당 값을 캐쉬에 업데이트 합니다.

### 3. Write Through
- 데이터 저장시 캐쉬에 먼저 저장
- **캐쉬**는 해당 데이터를 원본 저장소에 저장
- 서버는 캐쉬에 조회

**장점**
- 캐쉬와 원본 저장소간 정합성 불일치 문제 해소

**단점**
- 저장시 2단계를 거치기에 느림
- 캐쉬에 저장된 데이터를 다시 조회하지 않는다면 리소스 낭비 (TTL로 해결)

### 4. Write Around
- 쓰기 요청은 DB에만 저장한다
- 읽기 요청은 캐쉬에만 조회한다

**장점**
- 매우 빠르다

**단점**
- 정합성 문제

## 참고
- [로컬 vs 글로벌 캐싱](https://kk-programming.tistory.com/83)
- [캐쉬 알아보기](https://yoongrammer.tistory.com/101#Write_Around)
</details>


## 2. Redis 를 이용한 로직 이관
좌석 예약을 실제 DB를 이용하지 않고, Redis 분산락을 이용하여 전체 로직을 이관하겠습니다.  
현재는 좌석 예약을 시도하면 분산락을 얻고 해당 좌석에 접근을 제한하는 용도로 그쳤습니다.    
좌석 점유 시간(TTL)을 설정하여 유저 식별자와 함께 Set 자료구조에 저장하겠습니다.  

**좌석을 예매하지 않는다면** TTL의 만료로 점유가 풀릴 것입니다.  
**좌석을 예매한다면** 앞서 말했던 캐싱 전략의 Write-Through를 이용하여 해당 정보를 Redis에 저장하겠습니다. 

이를 통해 **DB Connection** 재원을 아끼고, 응답 시간을 개선할 수 있습니다.

<details>
  <summary>참고</summary>
  
## 참고  

- 항해 플러스 노션 7주차 발제  
- [티켓 마스터 설계](https://www.hellointerview.com/learn/system-design/answer-keys/ticketmaster)

</details>

